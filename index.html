<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>–£—á–∏ –¢–µ—Ä–º–∏–Ω—ã PRO</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --primary: #2563eb;
            --bg: #f1f5f9;
            --card-bg: #ffffff;
            --text-main: #0f172a;
            --text-sub: #64748b;
            --success: #10b981;
            --error: #ef4444;
            --radius: 20px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, system-ui, sans-serif; }
        
        body { 
            background: var(--bg); 
            display: flex; align-items: center; justify-content: center; 
            min-height: 100vh; padding: 15px; 
        }

        .app-container {
            width: 100%; max-width: 400px; height: 85vh;
            background: var(--card-bg); border-radius: var(--radius);
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
            display: flex; flex-direction: column; overflow: hidden;
            position: relative;
        }

        /* –®–∞–ø–∫–∞ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º */
        .header {
            padding: 20px; text-align: center; border-bottom: 1px solid #f1f5f9;
        }
        .cloud-status {
            display: inline-flex; align-items: center; gap: 6px;
            padding: 4px 12px; border-radius: 20px; background: #f8fafc;
            font-size: 12px; font-weight: 600; color: var(--text-sub);
        }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #cbd5e1; }
        .status-dot.online { background: var(--success); box-shadow: 0 0 8px var(--success); }

        /* –≠–∫—Ä–∞–Ω—ã */
        .screen { display: none; flex-direction: column; height: 100%; padding: 20px; overflow-y: auto; }
        .screen.active { display: flex; animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        h1 { font-size: 24px; font-weight: 800; color: var(--text-main); margin-bottom: 20px; }

        /* –ö–Ω–æ–ø–∫–∏ */
        .btn {
            width: 100%; padding: 16px; margin: 8px 0; border: none; border-radius: 16px;
            font-size: 16px; font-weight: 700; cursor: pointer; transition: 0.2s;
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .btn:active { transform: scale(0.96); }
        .btn-main { background: var(--primary); color: white; }
        .btn-alt { background: #eff6ff; color: var(--primary); }
        .btn-gray { background: #f8fafc; color: var(--text-main); border: 1px solid #e2e8f0; }

        /* –°–ø–∏—Å–æ–∫ —Ç–µ–º (–ò–°–ü–†–ê–í–õ–ï–ù–û –ù–ê–õ–û–ñ–ï–ù–ò–ï) */
        .topic-card {
            background: #ffffff; border: 1px solid #e2e8f0; border-radius: 16px;
            padding: 16px; margin-bottom: 12px;
            display: flex; align-items: center; justify-content: space-between;
        }
        .topic-info { flex: 1; min-width: 0; padding-right: 10px; }
        .topic-info b { display: block; font-size: 16px; color: var(--text-main); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .topic-info span { font-size: 13px; color: var(--text-sub); }
        .topic-btns { display: flex; gap: 8px; flex-shrink: 0; }
        .icon-btn { width: 40px; height: 40px; border-radius: 12px; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; }

        /* –ö–≤–∏–∑ */
        .quiz-card {
            background: var(--primary); padding: 40px 20px; border-radius: 20px;
            color: white; text-align: center; font-size: 24px; font-weight: 800; margin-bottom: 20px;
        }
        .option {
            background: white; border: 2px solid #f1f5f9; padding: 16px; border-radius: 16px;
            margin-bottom: 10px; cursor: pointer; font-weight: 600; transition: 0.2s;
        }
        .option.correct { background: var(--success) !important; color: white; border-color: var(--success); }
        .option.wrong { background: var(--error) !important; color: white; border-color: var(--error); }

        input { width: 100%; padding: 16px; margin-bottom: 12px; border: 2px solid #f1f5f9; border-radius: 14px; font-size: 16px; }
    </style>
</head>
<body>

<div class="app-container">
    <div class="header">
        <div class="cloud-status">
            <div id="dot" class="status-dot"></div>
            <span id="status-text">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
        </div>
    </div>

    <div id="home" class="screen active">
        <h1 style="text-align: center;">üéì –£—á–∏ –¢–µ—Ä–º–∏–Ω—ã</h1>
        <button class="btn btn-main" onclick="app.nav('subjects', 'quiz')">–ù–∞—á–∞—Ç—å –æ–±—É—á–µ–Ω–∏–µ</button>
        <button class="btn btn-alt" onclick="app.nav('create')">–°–æ–∑–¥–∞—Ç—å –±–∞–∑—É</button>
        <button class="btn btn-gray" onclick="app.showDB()">üóÇÔ∏è –ú–æ—è –±–∞–∑–∞</button>
        <button class="btn btn-gray" onclick="app.nav('subjects', 'stats')" style="background:#e0e7ff; color:#4338ca; border:none;">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
    </div>

    <div id="manage" class="screen">
        <h1>–ú–æ—è –±–∞–∑–∞</h1>
        <div id="db-list" style="flex: 1;"></div>
        <button class="btn btn-gray" onclick="app.nav('home')">–ù–∞–∑–∞–¥</button>
    </div>

    <div id="create" class="screen">
        <h1 id="create-h">–ù–æ–≤–∞—è —Ç–µ–º–∞</h1>
        <input type="text" id="in-sub" placeholder="–ü—Ä–µ–¥–º–µ—Ç">
        <input type="text" id="in-top" placeholder="–¢–µ–º–∞">
        <div id="terms-area"></div>
        <button class="btn btn-gray" onclick="app.addRow()">+ –¢–µ—Ä–º–∏–Ω</button>
        <button class="btn btn-main" onclick="app.save()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button class="btn btn-gray" onclick="app.nav('home')">–û—Ç–º–µ–Ω–∞</button>
    </div>

    <div id="quiz" class="screen">
        <div id="q-card" class="quiz-card">...</div>
        <div id="q-options"></div>
        <button id="btn-next" class="btn btn-main" style="display:none" onclick="app.nextQ()">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
    </div>

    <div id="subjects" class="screen"><h1>–ü—Ä–µ–¥–º–µ—Ç—ã</h1><div id="sub-list"></div><button class="btn btn-gray" onclick="app.nav('home')">–ù–∞–∑–∞–¥</button></div>
    <div id="topics" class="screen"><h1>–¢–µ–º—ã</h1><div id="top-list"></div><button class="btn btn-gray" onclick="app.nav('subjects')">–ù–∞–∑–∞–¥</button></div>
    
    <div id="stats-view" class="screen">
        <h1 id="st-title">–ü—Ä–æ–≥—Ä–µ—Å—Å</h1>
        <canvas id="chart"></canvas>
        <button class="btn btn-gray" style="margin-top:20px" onclick="app.nav('home')">–í –º–µ–Ω—é</button>
    </div>
</div>

<script>
    const S_URL = 'https://irrxjckolvcktxigneaq.supabase.co';
    const S_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlycnhqY2tvbHZja3R4aWduZWFxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA4MTczNjgsImV4cCI6MjA4NjM5MzM2OH0.3Xa99p5pQO5vhQmtL9ucbazwpsqdVjKqmtraxWl0Rws';
    const sb = window.supabase.createClient(S_URL, S_KEY);

    const app = {
        data: [], mode: '', editId: null, chart: null,
        
        async init() { await this.load(); },

        async load() {
            const { data, error } = await sb.from('study_sets').select('*').order('created_at', {ascending: false});
            if(!error) {
                this.data = data;
                document.getElementById('dot').classList.add('online');
                document.getElementById('status-text').innerText = '–û–±–ª–∞–∫–æ –∞–∫—Ç–∏–≤–Ω–æ';
            }
        },

        nav(id, mode) {
            if(mode) this.mode = mode;
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(id === 'subjects') this.renderSubs();
        },

        renderSubs() {
            const container = document.getElementById('sub-list'); container.innerHTML = '';
            [...new Set(this.data.map(x => x.subject))].forEach(s => {
                const b = document.createElement('button'); b.className = 'btn btn-alt'; b.innerText = s;
                b.onclick = () => this.renderTops(s); container.appendChild(b);
            });
        },

        renderTops(s) {
            const container = document.getElementById('top-list'); container.innerHTML = '';
            this.data.filter(x => x.subject === s).forEach(t => {
                const b = document.createElement('button'); b.className = 'btn btn-alt'; b.innerText = t.topic;
                b.onclick = () => this.mode === 'quiz' ? this.startQuiz(t) : this.showChart(t);
                container.appendChild(b);
            });
            this.nav('topics');
        },

        showDB() {
            const list = document.getElementById('db-list'); list.innerHTML = '';
            this.data.forEach(item => {
                const div = document.createElement('div'); div.className = 'topic-card';
                div.innerHTML = `
                    <div class="topic-info"><b>${item.topic}</b><span>${item.subject}</span></div>
                    <div class="topic-btns">
                        <button class="icon-btn" style="background:#dcfce7" onclick="app.edit('${item.id}')">‚úèÔ∏è</button>
                        <button class="icon-btn" style="background:#fee2e2" onclick="app.del('${item.id}')">üóëÔ∏è</button>
                    </div>`;
                list.appendChild(div);
            });
            this.nav('manage');
        },

        // –û—Å—Ç–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ –∫–≤–∏–∑–∞ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è...
        addRow(t='', d='') {
            const div = document.createElement('div'); div.style.display='flex'; div.style.gap='5px';
            div.innerHTML = `<input type="text" class="t" placeholder="–°–ª–æ–≤–æ" value="${t}"><input type="text" class="d" placeholder="–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ" value="${d}">`;
            document.getElementById('terms-area').appendChild(div);
        },

        async save() {
            const s = document.getElementById('in-sub').value;
            const t = document.getElementById('in-top').value;
            const terms = Array.from(document.querySelectorAll('#terms-area div')).map(d => ({
                t: d.querySelector('.t').value, d: d.querySelector('.d').value
            })).filter(x => x.t && x.d);

            if(this.editId) await sb.from('study_sets').update({subject:s, topic:t, terms}).eq('id', this.editId);
            else await sb.from('study_sets').insert([{subject:s, topic:t, terms}]);
            
            await this.load(); this.nav('home');
        },

        async del(id) { if(confirm('–£–¥–∞–ª–∏—Ç—å?')) { await sb.from('study_sets').delete().eq('id', id); await this.load(); this.showDB(); } },

        edit(id) {
            const item = this.data.find(x => x.id == id); this.editId = id;
            document.getElementById('in-sub').value = item.subject;
            document.getElementById('in-top').value = item.topic;
            document.getElementById('terms-area').innerHTML = '';
            item.terms.forEach(tr => this.addRow(tr.t, tr.d));
            this.nav('create');
        }
    };

    window.onload = () => app.init();
</script>
</body>
</html>
