<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>–£—á–∏ –¢–µ—Ä–º–∏–Ω—ã PRO</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #2563eb;
            --bg: #f8fafc;
            --card: #ffffff;
            --text: #0f172a;
            --text-sub: #64748b;
            --success: #10b981;
            --error: #ef4444;
            --radius: 24px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, system-ui, sans-serif; }
        body { background: #f1f5f9; display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 15px; }

        .app-container {
            width: 100%; max-width: 400px; height: 90vh;
            background: var(--card); border-radius: var(--radius);
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.15);
            display: flex; flex-direction: column; overflow: hidden;
            position: relative;
        }

        /* –ê–ù–ò–ú–ê–¶–ò–Ø –ü–ï–†–ï–•–û–î–ê */
        @keyframes screenIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .screen { 
            display: none; flex-direction: column; height: 100%; padding: 25px; 
            overflow-y: auto; scrollbar-width: none;
        }
        .screen.active { 
            display: flex; 
            animation: screenIn 0.4s ease-out forwards; 
        }

        .header { padding: 15px; text-align: center; border-bottom: 1px solid #f1f5f9; z-index: 10; }
        .cloud-badge {
            display: inline-flex; align-items: center; gap: 8px;
            padding: 6px 16px; border-radius: 20px; background: #f1f5f9;
            font-size: 13px; font-weight: 600; color: var(--text-sub);
        }
        .dot { width: 8px; height: 8px; border-radius: 50%; background: #cbd5e1; }
        .dot.online { background: var(--success); box-shadow: 0 0 8px var(--success); }

        h1 { font-size: 26px; font-weight: 800; color: var(--text); margin-bottom: 25px; text-align: center; letter-spacing: -0.5px; }

        .btn {
            width: 100%; padding: 18px; margin: 10px 0; border: none; border-radius: 18px;
            font-size: 16px; font-weight: 700; cursor: pointer; transition: all 0.2s ease;
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .btn:active { transform: scale(0.96); opacity: 0.9; }
        .btn-main { background: var(--primary); color: white; box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.3); }
        .btn-gray { background: #f8fafc; color: var(--text); border: 1px solid #e2e8f0; }

        /* –ö–ê–†–¢–û–ß–ö–ò –°–¢–ê–¢–ò–°–¢–ò–ö–ò */
        .term-stat-card {
            background: #fff; border: 1px solid #e2e8f0; border-radius: 16px;
            padding: 14px 18px; margin-bottom: 10px;
            display: flex; justify-content: space-between; align-items: center;
            transition: 0.2s;
        }
        .term-name { font-weight: 700; color: var(--text); font-size: 15px; }
        .term-perc { font-size: 12px; font-weight: 800; padding: 5px 12px; border-radius: 10px; min-width: 60px; text-align: center; }
        
        .perc-low { color: var(--error); background: #fef2f2; }
        .perc-mid { color: #f59e0b; background: #fffbeb; }
        .perc-high { color: var(--success); background: #f0fdf4; }

        .q-card { 
            background: var(--primary); padding: 35px 20px; border-radius: 24px; 
            color: white; text-align: center; font-size: 20px; font-weight: 700; 
            margin-bottom: 25px; min-height: 140px; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 15px 30px -10px rgba(37, 99, 235, 0.4);
        }
        .opt { 
            background: white; border: 2px solid #f1f5f9; padding: 18px; border-radius: 18px; 
            margin-bottom: 12px; cursor: pointer; font-weight: 600; text-align: center; 
            transition: 0.2s cubic-bezier(0.4, 0, 0.2, 1); 
        }
        .opt:hover { border-color: #cbd5e1; }
        .opt.correct { background: var(--success) !important; color: white; border-color: var(--success); transform: scale(1.02); }
        .opt.wrong { background: var(--error) !important; color: white; border-color: var(--error); transform: shake 0.3s; }

        .progress-bar { width: 100%; height: 8px; background: #f1f5f9; border-radius: 10px; margin-bottom: 20px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--success); width: 0%; transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1); }

        input { width: 100%; padding: 16px; border: 2px solid #f1f5f9; border-radius: 16px; font-size: 16px; margin-bottom: 12px; outline: none; transition: 0.2s; }
        input:focus { border-color: var(--primary); }
    </style>
</head>
<body>

<div class="app-container">
    <div class="header">
        <div class="cloud-badge">
            <div id="status-dot" class="dot"></div>
            <span id="status-text">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
        </div>
    </div>

    <div id="home" class="screen active">
        <h1>üéì –£—á–∏ –¢–µ—Ä–º–∏–Ω—ã</h1>
        <button class="btn btn-main" onclick="app.navSelect('quiz')">–ù–∞—á–∞—Ç—å –æ–±—É—á–µ–Ω–∏–µ</button>
        <button class="btn btn-gray" onclick="app.openCreate()" style="background: #eff6ff; border:none; color: var(--primary)">–°–æ–∑–¥–∞—Ç—å –±–∞–∑—É</button>
        <button class="btn btn-gray" onclick="app.showManage()">üìÅ –ú–æ—è –±–∞–∑–∞</button>
        <button class="btn btn-gray" onclick="app.navSelect('stats')" style="background:#e0e7ff; color:#4338ca; border:none;">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
    </div>

    <div id="stats" class="screen">
        <h1 id="st-title">–ü—Ä–æ–≥—Ä–µ—Å—Å</h1>
        <div style="background: white; border-radius: 20px; padding: 12px; border: 1px solid #e2e8f0; margin-bottom: 25px;">
            <canvas id="lineChart"></canvas>
        </div>
        <div id="term-stats-list" style="flex: 1;"></div>
        <button class="btn btn-gray" onclick="app.nav('home')">–ù–∞–∑–∞–¥</button>
    </div>

    <div id="quiz" class="screen">
        <div class="progress-bar"><div id="q-progress" class="progress-fill"></div></div>
        <div id="q-card" class="q-card">...</div>
        <div id="q-options"></div>
        <button id="q-next" class="btn btn-main" style="display:none" onclick="app.nextQuestion()">–î–∞–ª–µ–µ</button>
    </div>

    <div id="create" class="screen"><h1 id="create-h">–ù–æ–≤–∞—è —Ç–µ–º–∞</h1><input type="text" id="in-sub" placeholder="–ü—Ä–µ–¥–º–µ—Ç"><input type="text" id="in-top" placeholder="–¢–µ–º–∞"><div id="terms-list"></div><button class="btn btn-gray" onclick="app.addRow()">+ –¢–µ—Ä–º–∏–Ω</button><button class="btn btn-main" onclick="app.save()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button><button class="btn btn-gray" onclick="app.nav('home')">–ù–∞–∑–∞–¥</button></div>
    <div id="manage" class="screen"><h1>–ú–æ—è –±–∞–∑–∞</h1><div id="db-list"></div><button class="btn btn-gray" onclick="app.nav('home')">–ù–∞–∑–∞–¥</button></div>
    <div id="select-sub" class="screen"><h1>–ü—Ä–µ–¥–º–µ—Ç—ã</h1><div id="sub-list"></div><button class="btn btn-gray" onclick="app.nav('home')">–ù–∞–∑–∞–¥</button></div>
    <div id="select-top" class="screen"><h1>–¢–µ–º—ã</h1><div id="top-list"></div><button class="btn btn-gray" onclick="app.nav('select-sub')">–ù–∞–∑–∞–¥</button></div>
</div>

<script>
    const S_URL = 'https://irrxjckolvcktxigneaq.supabase.co';
    const S_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlycnhqY2tvbHZja3R4aWduZWFxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA4MTczNjgsImV4cCI6MjA4NjM5MzM2OH0.3Xa99p5pQO5vhQmtL9ucbazwpsqdVjKqmtraxWl0Rws';
    let sb;
    try { sb = window.supabase.createClient(S_URL, S_KEY); } catch(e) {}

    const app = {
        data: [], mode: '', currentSetId: null, myChart: null,
        quizQueue: [], sessionCorrect: 0, sessionTotal: 0,

        async init() { this.refresh(); },

        async refresh() {
            const { data, error } = await sb.from('study_sets').select('*').order('created_at', {ascending: false});
            if(!error) {
                this.data = data;
                document.getElementById('status-dot').classList.add('online');
                document.getElementById('status-text').innerText = '–û–±–ª–∞–∫–æ –∞–∫—Ç–∏–≤–Ω–æ';
            }
        },

        nav(id) {
            const screens = document.querySelectorAll('.screen');
            screens.forEach(s => s.classList.remove('active'));
            const next = document.getElementById(id);
            next.classList.add('active');
            // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–≤–µ—Ä—Ö –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ
            next.scrollTop = 0;
        },

        saveProgress(setId, score, termResults) {
            let history = JSON.parse(localStorage.getItem('study_history_' + setId) || '[]');
            history.push(score);
            localStorage.setItem('study_history_' + setId, JSON.stringify(history));

            let termStats = JSON.parse(localStorage.getItem('term_stats_' + setId) || '{}');
            for (let t in termResults) {
                if (!termStats[t]) termStats[t] = { ok: 0, total: 0 };
                termStats[t].ok += termResults[t].ok;
                termStats[t].total += termResults[t].total;
            }
            localStorage.setItem('term_stats_' + setId, JSON.stringify(termStats));
        },

        showStats(set) {
            this.nav('stats');
            document.getElementById('st-title').innerText = set.topic;
            
            const history = JSON.parse(localStorage.getItem('study_history_' + set.id) || '[]');
            const termStats = JSON.parse(localStorage.getItem('term_stats_' + set.id) || '{}');

            const ctx = document.getElementById('lineChart').getContext('2d');
            if(this.myChart) this.myChart.destroy();
            
            this.myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: history.map((_, i) => 'S' + (i+1)),
                    datasets: [{
                        data: history, 
                        borderColor: '#2563eb', tension: 0.3, fill: true, 
                        backgroundColor: 'rgba(37, 99, 235, 0.05)',
                        borderWidth: 3, pointRadius: 4, pointBackgroundColor: '#2563eb'
                    }]
                },
                options: { 
                    plugins: { legend: { display: false } }, 
                    scales: { y: { min: 0, max: 100, grid: { color: '#f1f5f9' } }, x: { grid: { display: false } } } 
                }
            });

            const list = document.getElementById('term-stats-list');
            list.innerHTML = history.length === 0 ? '<p style="text-align:center; color:var(--text-sub); margin-top:20px;">–ü—Ä–æ–π–¥–∏—Ç–µ —Ç–µ—Å—Ç, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</p>' : '';
            
            let displayTerms = set.terms.map(t => {
                const stat = termStats[t.t] || { ok: 0, total: 0 };
                const perc = stat.total > 0 ? Math.round((stat.ok / stat.total) * 100) : 0;
                return { ...t, perc };
            }).sort((a, b) => a.perc - b.perc);

            displayTerms.forEach(t => {
                const cls = t.perc < 40 ? 'perc-low' : (t.perc < 80 ? 'perc-mid' : 'perc-high');
                const row = document.createElement('div');
                row.className = 'term-stat-card';
                row.innerHTML = `<span class="term-name">${t.t}</span><span class="term-perc ${cls}">${t.perc}%</span>`;
                list.appendChild(row);
            });
        },

        startQuiz(set) {
            this.currentSetId = set.id;
            this.quizQueue = [];
            this.sessionCorrect = 0;
            this.sessionTotal = 0;
            this.termResults = {};

            set.terms.forEach(t => { 
                this.termResults[t.t] = { ok: 0, total: 0 };
                for(let i=0; i<3; i++) this.quizQueue.push({...t, all: set.terms}); 
            });
            this.quizQueue.sort(() => Math.random() - 0.5);
            this.maxQ = this.quizQueue.length;
            this.nav('quiz');
            this.nextQuestion();
        },

        nextQuestion() {
            if(this.quizQueue.length === 0) {
                const finalScore = Math.round((this.sessionCorrect / this.sessionTotal) * 100);
                this.saveProgress(this.currentSetId, finalScore, this.termResults);
                alert(`–ö–≤–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω! –¢–æ—á–Ω–æ—Å—Ç—å: ${finalScore}%`);
                return this.nav('home');
            }
            this.curr = this.quizQueue.shift();
            document.getElementById('q-card').innerText = this.curr.t;
            const opts = document.getElementById('q-options'), next = document.getElementById('q-next');
            opts.innerHTML = ''; next.style.display = 'none';

            let ans = [this.curr.d, ...this.curr.all.filter(x => x.d !== this.curr.d).map(x => x.d).sort(() => Math.random() - 0.5).slice(0, 3)];
            ans.sort(() => Math.random() - 0.5).forEach(a => {
                const b = document.createElement('div'); b.className = 'opt'; b.innerText = a;
                b.onclick = () => {
                    if(next.style.display !== 'none') return;
                    this.sessionTotal++;
                    this.termResults[this.curr.t].total++;
                    if(a === this.curr.d) {
                        b.classList.add('correct');
                        this.sessionCorrect++;
                        this.termResults[this.curr.t].ok++;
                    } else {
                        b.classList.add('wrong');
                        this.quizQueue.push(this.curr);
                    }
                    next.style.display = 'block';
                    document.getElementById('q-progress').style.width = ((this.maxQ - this.quizQueue.length) / this.maxQ * 100) + '%';
                };
                opts.appendChild(b);
            });
        },

        addRow(t='', d='') {
            const r = document.createElement('div'); r.style.display='flex'; r.style.gap='10px';
            r.innerHTML = `<input type="text" class="t" placeholder="–°–ª–æ–≤–æ" value="${t}"><input type="text" class="d" placeholder="–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ" value="${d}">`;
            document.getElementById('terms-list').appendChild(r);
        },
        async save() {
            const sub = document.getElementById('in-sub').value, top = document.getElementById('in-top').value;
            const terms = Array.from(document.querySelectorAll('#terms-list div')).map(r => ({t: r.querySelector('.t').value, d: r.querySelector('.d').value})).filter(x => x.t && x.d);
            if(this.editId) await sb.from('study_sets').update({subject:sub, topic:top, terms}).eq('id', this.editId);
            else await sb.from('study_sets').insert([{subject:sub, topic:top, terms}]);
            await this.refresh(); this.nav('home');
        },
        showManage() {
            const list = document.getElementById('db-list'); list.innerHTML = '';
            this.data.forEach(it => {
                const c = document.createElement('div'); c.style.cssText="background:#fff; border:1px solid #e2e8f0; border-radius:18px; padding:18px; margin-bottom:12px; display:flex; justify-content:space-between; align-items:center;";
                c.innerHTML = `<div><b style="color:var(--text); font-size:16px;">${it.topic}</b><br><small style="color:var(--text-sub)">${it.subject}</small></div><div><button onclick="app.edit('${it.id}')" style="border:none; background:none; font-size:20px; cursor:pointer;">‚úèÔ∏è</button><button onclick="app.del('${it.id}')" style="border:none; background:none; font-size:20px; margin-left:12px; cursor:pointer;">üóëÔ∏è</button></div>`;
                list.appendChild(c);
            });
            this.nav('manage');
        },
        edit(id) { 
            const it = this.data.find(x => x.id == id); this.editId = id; 
            document.getElementById('in-sub').value = it.subject; document.getElementById('in-top').value = it.topic;
            document.getElementById('terms-list').innerHTML = ''; it.terms.forEach(p => this.addRow(p.t, p.d)); this.nav('create'); 
        },
        async del(id) { if(confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É —Ç–µ–º—É?')) { await sb.from('study_sets').delete().eq('id', id); await this.refresh(); this.showManage(); } },
        navSelect(m) { 
            this.mode = m; const list = document.getElementById('sub-list'); list.innerHTML = '';
            [...new Set(this.data.map(x => x.subject))].forEach(s => {
                const b = document.createElement('button'); b.className = 'btn btn-alt'; b.style.background="#eff6ff"; b.style.color="var(--primary)"; b.innerText = s; b.onclick = () => this.navTopics(s); list.appendChild(b);
            });
            this.nav('select-sub');
        },
        navTopics(s) {
            const list = document.getElementById('top-list'); list.innerHTML = '';
            this.data.filter(x => x.subject === s).forEach(t => {
                const b = document.createElement('button'); b.className = 'btn btn-alt'; b.style.background="#eff6ff"; b.style.color="var(--primary)"; b.innerText = t.topic;
                b.onclick = () => this.mode === 'quiz' ? this.startQuiz(t) : this.showStats(t); list.appendChild(b);
            });
            this.nav('select-top');
        },
        openCreate() { this.editId = null; document.getElementById('create-h').innerText = '–ù–æ–≤–∞—è —Ç–µ–º–∞'; document.getElementById('terms-list').innerHTML = ''; this.addRow(); this.nav('create'); }
    };
    window.onload = () => app.init();
</script>
</body>
</html>
