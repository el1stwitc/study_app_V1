<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>–£—á–∏ –¢–µ—Ä–º–∏–Ω—ã PRO</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #2563eb;
            --bg: #f8fafc;
            --card: #ffffff;
            --text: #0f172a;
            --text-sub: #64748b;
            --success: #10b981;
            --error: #ef4444;
            --radius: 20px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, system-ui, sans-serif; }
        body { background: #f1f5f9; display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 15px; }

        .app-container {
            width: 100%; max-width: 400px; height: 85vh;
            background: var(--card); border-radius: var(--radius);
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
            display: flex; flex-direction: column; overflow: hidden;
        }

        /* –®–ê–ü–ö–ê */
        .header {
            padding: 15px; text-align: center; border-bottom: 1px solid #f1f5f9;
            display: flex; flex-direction: column; align-items: center; gap: 8px;
        }
        .cloud-badge {
            display: inline-flex; align-items: center; gap: 8px;
            padding: 6px 16px; border-radius: 20px; background: #f1f5f9;
            font-size: 13px; font-weight: 600; color: var(--text-sub);
        }
        .dot { width: 8px; height: 8px; border-radius: 50%; background: #cbd5e1; }
        .dot.online { background: var(--success); box-shadow: 0 0 8px var(--success); }

        /* –≠–ö–†–ê–ù–´ */
        .screen { display: none; flex-direction: column; height: 100%; padding: 20px; overflow-y: auto; }
        .screen.active { display: flex; }

        h1 { font-size: 24px; font-weight: 800; color: var(--text); margin: 10px 0 20px; text-align: center; }

        /* –ö–ù–û–ü–ö–ò */
        .btn {
            width: 100%; padding: 16px; margin: 8px 0; border: none; border-radius: 16px;
            font-size: 16px; font-weight: 700; cursor: pointer; transition: 0.2s;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            text-decoration: none;
        }
        .btn:active { transform: scale(0.97); opacity: 0.9; }
        .btn-main { background: var(--primary); color: white; }
        .btn-alt { background: #eff6ff; color: var(--primary); }
        .btn-gray { background: #f8fafc; color: var(--text); border: 1px solid #e2e8f0; }

        /* –ö–ê–†–¢–û–ß–ö–ê –ë–ê–ó–´ (–§–ò–ö–° –ù–ê–õ–û–ñ–ï–ù–ò–Ø) */
        .db-card {
            background: #fff; border: 1px solid #e2e8f0; border-radius: 16px;
            padding: 16px; margin-bottom: 12px;
            display: flex; align-items: center; justify-content: space-between;
        }
        .db-info { flex: 1; min-width: 0; padding-right: 15px; }
        .db-info b { display: block; font-size: 16px; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .db-info span { font-size: 13px; color: var(--text-sub); }
        .db-actions { display: flex; gap: 10px; flex-shrink: 0; }
        
        .icon-btn { 
            width: 40px; height: 40px; border-radius: 12px; border: none; 
            cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; 
        }

        input { width: 100%; padding: 14px; border: 2px solid #f1f5f9; border-radius: 14px; font-size: 16px; margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="app-container">
    <div class="header">
        <div class="cloud-badge">
            <div id="status-dot" class="dot"></div>
            <span id="status-text">–û—Ñ–ª–∞–π–Ω</span>
        </div>
    </div>

    <div id="home" class="screen active">
        <h1>üéì –£—á–∏ –¢–µ—Ä–º–∏–Ω—ã</h1>
        <button class="btn btn-main" onclick="app.navSelect('quiz')">–ù–∞—á–∞—Ç—å –æ–±—É—á–µ–Ω–∏–µ</button>
        <button class="btn btn-alt" onclick="app.openCreate()">–°–æ–∑–¥–∞—Ç—å –±–∞–∑—É</button>
        <button class="btn btn-gray" onclick="app.showManage()">üìÅ –ú–æ—è –±–∞–∑–∞</button>
        <button class="btn btn-gray" onclick="app.navSelect('stats')" style="background:#e0e7ff; color:#4338ca; border:none;">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
    </div>

    <div id="manage" class="screen">
        <h1>–ú–æ—è –±–∞–∑–∞</h1>
        <div id="db-list" style="flex: 1;"></div>
        <button class="btn btn-gray" onclick="app.goHome()">–ù–∞–∑–∞–¥</button>
    </div>

    <div id="create" class="screen">
        <h1 id="create-h">–ù–æ–≤–∞—è —Ç–µ–º–∞</h1>
        <input type="text" id="in-sub" placeholder="–ü—Ä–µ–¥–º–µ—Ç">
        <input type="text" id="in-top" placeholder="–¢–µ–º–∞">
        <div id="terms-list"></div>
        <button class="btn btn-gray" onclick="app.addRow()">+ –¢–µ—Ä–º–∏–Ω</button>
        <button class="btn btn-main" onclick="app.save()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button class="btn btn-gray" onclick="app.goHome()">–û—Ç–º–µ–Ω–∞</button>
    </div>

    <div id="select-sub" class="screen"><h1>–ü—Ä–µ–¥–º–µ—Ç—ã</h1><div id="sub-list"></div><button class="btn btn-gray" onclick="app.goHome()">–ù–∞–∑–∞–¥</button></div>
    <div id="select-top" class="screen"><h1>–¢–µ–º—ã</h1><div id="top-list"></div><button class="btn btn-gray" onclick="app.navSelect(app.mode)">–ù–∞–∑–∞–¥</button></div>
</div>

<script>
    // –í–°–¢–ê–í–¨ –°–í–û–ò –î–ê–ù–ù–´–ï –¢–£–¢
    const S_URL = 'https://irrxjckolvcktxigneaq.supabase.co';
    const S_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlycnhqY2tvbHZja3R4aWduZWFxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA4MTczNjgsImV4cCI6MjA4NjM5MzM2OH0.3Xa99p5pQO5vhQmtL9ucbazwpsqdVjKqmtraxWl0Rws';
    
    let sb;
    try {
        sb = window.supabase.createClient(S_URL, S_KEY);
    } catch(e) { console.error("Supabase init error"); }

    const app = {
        data: [], mode: '', editId: null,

        async init() {
            console.log("App starting...");
            await this.refresh();
        },

        async refresh() {
            try {
                const { data, error } = await sb.from('study_sets').select('*').order('created_at', {ascending: false});
                if(!error && data) {
                    this.data = data;
                    document.getElementById('status-dot').classList.add('online');
                    document.getElementById('status-text').innerText = '–û–±–ª–∞–∫–æ –∞–∫—Ç–∏–≤–Ω–æ';
                }
            } catch(e) { 
                document.getElementById('status-text').innerText = '–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏';
            }
        },

        nav(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            const target = document.getElementById(id);
            if(target) target.classList.add('active');
        },

        goHome() { this.nav('home'); this.editId = null; },

        openCreate() {
            document.getElementById('create-h').innerText = '–ù–æ–≤–∞—è —Ç–µ–º–∞';
            document.getElementById('in-sub').value = '';
            document.getElementById('in-top').value = '';
            document.getElementById('terms-list').innerHTML = '';
            this.addRow();
            this.nav('create');
        },

        addRow(t='', d='') {
            const div = document.createElement('div');
            div.style.display = 'flex'; div.style.gap = '8px';
            div.innerHTML = `<input type="text" class="t" placeholder="–°–ª–æ–≤–æ" value="${t}"><input type="text" class="d" placeholder="–û–ø—Ä." value="${d}">`;
            document.getElementById('terms-list').appendChild(div);
        },

        async save() {
            const sub = document.getElementById('in-sub').value;
            const top = document.getElementById('in-top').value;
            const terms = Array.from(document.querySelectorAll('#terms-list div')).map(row => ({
                t: row.querySelector('.t').value, d: row.querySelector('.d').value
            })).filter(x => x.t && x.d);

            if(!sub || !top || terms.length === 0) return alert("–ó–∞–ø–æ–ª–Ω–∏ –≤—Å–µ –ø–æ–ª—è");

            if(this.editId) {
                await sb.from('study_sets').update({subject: sub, topic: top, terms}).eq('id', this.editId);
            } else {
                await sb.from('study_sets').insert([{subject: sub, topic: top, terms}]);
            }
            await this.refresh();
            this.goHome();
        },

        showManage() {
            const list = document.getElementById('db-list');
            list.innerHTML = '';
            this.data.forEach(item => {
                const card = document.createElement('div');
                card.className = 'db-card';
                card.innerHTML = `
                    <div class="db-info"><b>${item.topic}</b><span>${item.subject}</span></div>
                    <div class="db-actions">
                        <button class="icon-btn" style="background:#dcfce7" onclick="app.edit('${item.id}')">‚úèÔ∏è</button>
                        <button class="icon-btn" style="background:#fee2e2" onclick="app.del('${item.id}')">üóëÔ∏è</button>
                    </div>`;
                list.appendChild(card);
            });
            this.nav('manage');
        },

        edit(id) {
            const item = this.data.find(x => x.id == id);
            this.editId = id;
            document.getElementById('create-h').innerText = '–ü—Ä–∞–≤–∫–∞';
            document.getElementById('in-sub').value = item.subject;
            document.getElementById('in-top').value = item.topic;
            document.getElementById('terms-list').innerHTML = '';
            item.terms.forEach(pair => this.addRow(pair.t, pair.d));
            this.nav('create');
        },

        async del(id) {
            if(confirm('–£–¥–∞–ª–∏—Ç—å?')) {
                await sb.from('study_sets').delete().eq('id', id);
                await this.refresh();
                this.showManage();
            }
        },

        navSelect(mode) {
            this.mode = mode;
            const list = document.getElementById('sub-list');
            list.innerHTML = '';
            const subs = [...new Set(this.data.map(x => x.subject))];
            subs.forEach(s => {
                const b = document.createElement('button');
                b.className = 'btn btn-alt';
                b.innerText = s;
                b.onclick = () => this.navTopics(s);
                list.appendChild(b);
            });
            this.nav('select-sub');
        },

        navTopics(s) {
            const list = document.getElementById('top-list');
            list.innerHTML = '';
            this.data.filter(x => x.subject === s).forEach(t => {
                const b = document.createElement('button');
                b.className = 'btn btn-alt';
                b.innerText = t.topic;
                b.onclick = () => console.log("Action: " + this.mode); // –¢—É—Ç –±—É–¥–µ—Ç –≤—ã–∑–æ–≤ –∫–≤–∏–∑–∞ –∏–ª–∏ —Å—Ç–∞—Ç—ã
                list.appendChild(b);
            });
            this.nav('select-top');
        }
    };

    window.onload = () => app.init();
</script>
</body>
</html>
