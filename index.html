<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>–£—á–∏ –¢–µ—Ä–º–∏–Ω—ã PRO</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #2563eb;
            --bg: #f1f5f9;
            --card: #ffffff;
            --text: #0f172a;
            --text-sub: #64748b;
            --success: #10b981;
            --error: #ef4444;
            --radius: 20px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, system-ui, sans-serif; }
        body { background: var(--bg); display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 15px; }

        .app-container {
            width: 100%; max-width: 400px; height: 85vh;
            background: var(--card); border-radius: var(--radius);
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
            display: flex; flex-direction: column; overflow: hidden;
            position: relative;
        }

        /* –®–ê–ü–ö–ê */
        .header {
            padding: 15px; text-align: center; border-bottom: 1px solid #f1f5f9;
            display: flex; flex-direction: column; align-items: center; gap: 8px;
        }
        .cloud-badge {
            display: inline-flex; align-items: center; gap: 6px;
            padding: 5px 12px; border-radius: 20px; background: #f8fafc;
            font-size: 12px; font-weight: 700; color: var(--text-sub);
            border: 1px solid #e2e8f0;
        }
        .dot { width: 8px; height: 8px; border-radius: 50%; background: #cbd5e1; transition: 0.3s; }
        .dot.online { background: var(--success); box-shadow: 0 0 8px var(--success); }

        /* –≠–ö–†–ê–ù–´ */
        .screen { display: none; flex-direction: column; height: 100%; padding: 20px; overflow-y: auto; }
        .screen.active { display: flex; animation: slideUp 0.3s ease; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        h1 { font-size: 22px; font-weight: 800; color: var(--text); margin-bottom: 20px; text-align: center; }

        /* –ö–ù–û–ü–ö–ò */
        .btn {
            width: 100%; padding: 16px; margin: 8px 0; border: none; border-radius: 16px;
            font-size: 16px; font-weight: 700; cursor: pointer; transition: 0.2s;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn:active { transform: scale(0.97); }
        .btn-main { background: var(--primary); color: white; }
        .btn-alt { background: #eff6ff; color: var(--primary); }
        .btn-gray { background: #f8fafc; color: var(--text); border: 1px solid #e2e8f0; }

        /* –ö–ê–†–¢–û–ß–ö–ê –ë–ê–ó–´ */
        .db-card {
            background: #fff; border: 1px solid #e2e8f0; border-radius: 16px;
            padding: 16px; margin-bottom: 12px;
            display: flex; align-items: center; justify-content: space-between;
        }
        .db-info { flex: 1; min-width: 0; padding-right: 10px; }
        .db-info b { display: block; font-size: 16px; color: var(--text); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .db-info span { font-size: 13px; color: var(--text-sub); }
        .db-actions { display: flex; gap: 8px; }
        .action-btn { width: 40px; height: 40px; border-radius: 12px; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; }

        input { width: 100%; padding: 14px; border: 2px solid #f1f5f9; border-radius: 14px; font-size: 16px; margin-bottom: 8px; }
        .q-card { background: var(--primary); padding: 40px 20px; border-radius: 20px; color: white; text-align: center; font-size: 22px; font-weight: 800; margin-bottom: 20px; }
        .opt { background: white; border: 2px solid #f1f5f9; padding: 16px; border-radius: 16px; margin-bottom: 10px; cursor: pointer; font-weight: 600; text-align: center; }
        .opt.correct { background: var(--success) !important; color: white; }
        .opt.wrong { background: var(--error) !important; color: white; }
    </style>
</head>
<body>

<div class="app-container">
    <div class="header">
        <div class="cloud-badge">
            <div id="cloud-dot" class="dot"></div>
            <span id="cloud-text">–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ...</span>
        </div>
    </div>

    <div id="home" class="screen active">
        <h1>üéì –£—á–∏ –¢–µ—Ä–º–∏–Ω—ã</h1>
        <button class="btn btn-main" onclick="app.navSubjects('quiz')">–ù–∞—á–∞—Ç—å –æ–±—É—á–µ–Ω–∏–µ</button>
        <button class="btn btn-alt" onclick="app.nav('create')">–°–æ–∑–¥–∞—Ç—å –±–∞–∑—É</button>
        <button class="btn btn-gray" onclick="app.showDB()">üìÅ –ú–æ—è –±–∞–∑–∞</button>
        <button class="btn btn-gray" onclick="app.navSubjects('stats')" style="background:#e0e7ff; color:#4338ca; border:none;">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
    </div>

    <div id="manage" class="screen">
        <h1>–ú–æ—è –±–∞–∑–∞</h1>
        <div id="db-list" style="flex: 1;"></div>
        <button class="btn btn-gray" onclick="app.nav('home')">–ù–∞–∑–∞–¥</button>
    </div>

    <div id="create" class="screen">
        <h1 id="create-title">–ù–æ–≤–∞—è —Ç–µ–º–∞</h1>
        <input type="text" id="in-sub" placeholder="–ü—Ä–µ–¥–º–µ—Ç">
        <input type="text" id="in-top" placeholder="–¢–µ–º–∞">
        <div id="terms-list"></div>
        <button class="btn btn-gray" onclick="app.addRow()">+ –î–æ–±–∞–≤–∏—Ç—å —Å–ª–æ–≤–æ</button>
        <button class="btn btn-main" onclick="app.save()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button class="btn btn-gray" onclick="app.nav('home')">–ù–∞–∑–∞–¥</button>
    </div>

    <div id="quiz" class="screen">
        <div id="q-text" class="q-card">...</div>
        <div id="q-options"></div>
        <button id="q-next" class="btn btn-main" style="display:none" onclick="app.nextQ()">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
    </div>

    <div id="subjects" class="screen"><h1>–ü—Ä–µ–¥–º–µ—Ç—ã</h1><div id="sub-btns"></div><button class="btn btn-gray" onclick="app.nav('home')">–ù–∞–∑–∞–¥</button></div>
    <div id="topics" class="screen"><h1>–¢–µ–º—ã</h1><div id="top-btns"></div><button class="btn btn-gray" onclick="app.nav('subjects')">–ù–∞–∑–∞–¥</button></div>
    
    <div id="stats" class="screen">
        <h1 id="st-topic">–ü—Ä–æ–≥—Ä–µ—Å—Å</h1>
        <canvas id="chart"></canvas>
        <button class="btn btn-gray" onclick="app.nav('home')">–í –º–µ–Ω—é</button>
    </div>
</div>

<script>
    const URL = 'https://irrxjckolvcktxigneaq.supabase.co';
    const KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlycnhqY2tvbHZja3R4aWduZWFxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA4MTczNjgsImV4cCI6MjA4NjM5MzM2OH0.3Xa99p5pQO5vhQmtL9ucbazwpsqdVjKqmtraxWl0Rws';
    const sb = window.supabase.createClient(URL, KEY);

    const app = {
        data: [], mode: '', editId: null, chart: null,
        
        async init() { 
            await this.load(); 
        },

        async load() {
            try {
                const { data, error } = await sb.from('study_sets').select('*').order('created_at', {ascending: false});
                if(!error) {
                    this.data = data;
                    document.getElementById('cloud-dot').classList.add('online');
                    document.getElementById('cloud-text').innerText = '–û–±–ª–∞–∫–æ –∞–∫—Ç–∏–≤–Ω–æ';
                }
            } catch(e) { console.log(e) }
        },

        nav(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        },

        navSubjects(mode) {
            this.mode = mode;
            const div = document.getElementById('sub-btns'); div.innerHTML = '';
            [...new Set(this.data.map(x => x.subject))].forEach(s => {
                const b = document.createElement('button'); b.className = 'btn btn-alt'; b.innerText = s;
                b.onclick = () => this.navTopics(s); div.appendChild(b);
            });
            this.nav('subjects');
        },

        navTopics(s) {
            const div = document.getElementById('top-btns'); div.innerHTML = '';
            this.data.filter(x => x.subject === s).forEach(t => {
                const b = document.createElement('button'); b.className = 'btn btn-alt'; b.innerText = t.topic;
                b.onclick = () => this.mode === 'quiz' ? this.startQuiz(t) : this.showStats(t);
                div.appendChild(b);
            });
            this.nav('topics');
        },

        showDB() {
            const list = document.getElementById('db-list'); list.innerHTML = '';
            this.data.forEach(i => {
                const card = document.createElement('div'); card.className = 'db-card';
                card.innerHTML = `
                    <div class="db-info"><b>${i.topic}</b><span>${i.subject}</span></div>
                    <div class="db-actions">
                        <button class="action-btn" style="background:#dcfce7" onclick="app.edit('${i.id}')">‚úèÔ∏è</button>
                        <button class="action-btn" style="background:#fee2e2" onclick="app.del('${i.id}')">üóëÔ∏è</button>
                    </div>`;
                list.appendChild(card);
            });
            this.nav('manage');
        },

        addRow(t='', d='') {
            const div = document.createElement('div'); div.style.display='flex'; div.style.gap='8px';
            div.innerHTML = `<input type="text" class="t" placeholder="–°–ª–æ–≤–æ" value="${t}"><input type="text" class="d" placeholder="–û–ø—Ä." value="${d}">`;
            document.getElementById('terms-list').appendChild(div);
        },

        async save() {
            const sub = document.getElementById('in-sub').value;
            const top = document.getElementById('in-top').value;
            const terms = Array.from(document.querySelectorAll('#terms-list div')).map(d => ({
                t: d.querySelector('.t').value, d: d.querySelector('.d').value
            })).filter(x => x.t && x.d);

            if(this.editId) await sb.from('study_sets').update({subject:sub, topic:top, terms}).eq('id', this.editId);
            else await sb.from('study_sets').insert([{subject:sub, topic:top, terms}]);
            
            this.editId = null;
            await this.load(); this.nav('home');
        },

        edit(id) {
            const item = this.data.find(x => x.id == id); this.editId = id;
            document.getElementById('in-sub').value = item.subject;
            document.getElementById('in-top').value = item.topic;
            document.getElementById('terms-list').innerHTML = '';
            item.terms.forEach(tr => this.addRow(tr.t, tr.d));
            this.nav('create');
        },

        async del(id) { if(confirm('–£–¥–∞–ª–∏—Ç—å?')) { await sb.from('study_sets').delete().eq('id', id); await this.load(); this.showDB(); } }
    };

    window.onload = () => app.init();
</script>
</body>
</html>
